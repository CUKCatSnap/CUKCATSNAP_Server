name: Catsnap CI Test Workflow

on:
  pull_request:
    branches: [ "main" ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.filter.outputs.gateway }}
      mono: ${{ steps.filter.outputs.mono }}
      authentication: ${{ steps.filter.outputs.authentication }}
      authorization-shared: ${{ steps.filter.outputs.authorization-shared }}
      reservation: ${{ steps.filter.outputs.reservation }}
      event-schema-shared: ${{ steps.filter.outputs.event-schema-shared }}
      payment: ${{ steps.filter.outputs.payment }}
      common-files: ${{ steps.filter.outputs.common-files }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed modules
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'gateway/**'
            mono:
              - 'mono/**'
            authentication:
              - 'authentication/**'
            authorization-shared:
              - 'authorization-shared/**'
            reservation:
              - 'reservation/**'
            event-schema-shared:
              - 'event-schema-shared/**'
            payment:
              - 'payment/**'
            common-files:
              - 'settings.gradle'
              - 'gradle/**'
              - '.github/workflows/**'

  test-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true' || needs.detect-changes.outputs.authorization-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-gateway.yml

  test-mono:
    needs: detect-changes
    if: needs.detect-changes.outputs.mono == 'true' || needs.detect-changes.outputs.authorization-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-mono.yml

  test-authentication:
    needs: detect-changes
    if: needs.detect-changes.outputs.authentication == 'true' || needs.detect-changes.outputs.authorization-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-authentication.yml

  test-authorization-shared:
    needs: detect-changes
    if: needs.detect-changes.outputs.authorization-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-authorization-shared.yml

  test-reservation:
    needs: detect-changes
    if: needs.detect-changes.outputs.reservation == 'true' || needs.detect-changes.outputs.authorization-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-reservation.yml

  test-event-schema-shared:
    needs: detect-changes
    if: needs.detect-changes.outputs.event-schema-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-event-schema-shared.yml

  test-payment:
    needs: detect-changes
    if: needs.detect-changes.outputs.payment == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/test-payment.yml
