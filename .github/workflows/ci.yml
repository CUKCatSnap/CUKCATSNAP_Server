name: Catsnap CI Test Workflow

on:
  pull_request:
    branches: [ "main" ]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      gateway: ${{ steps.filter.outputs.gateway }}
      mono: ${{ steps.filter.outputs.mono }}
      authorization: ${{ steps.filter.outputs.authorization }}
      auth-shared: ${{ steps.filter.outputs.auth-shared }}
      common-files: ${{ steps.filter.outputs.common-files }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed modules
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'gateway/**'
            mono:
              - 'mono/**'
            authorization:
              - 'authorization/**'
            auth-shared:
              - 'auth-shared/**'
            common-files:
              - 'settings.gradle'
              - 'gradle/**'
              - '.github/workflows/**'

  test-gateway:
    needs: detect-changes
    if: needs.detect-changes.outputs.gateway == 'true' || needs.detect-changes.outputs.auth-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/ci/test-gateway.yml

  test-mono:
    needs: detect-changes
    if: needs.detect-changes.outputs.mono == 'true' || needs.detect-changes.outputs.auth-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/ci/test-mono.yml

  test-authorization:
    needs: detect-changes
    if: needs.detect-changes.outputs.authorization == 'true' || needs.detect-changes.outputs.auth-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/ci/test-authorization.yml

  test-auth-shared:
    needs: detect-changes
    if: needs.detect-changes.outputs.auth-shared == 'true' || needs.detect-changes.outputs.common-files == 'true'
    permissions:
      contents: read
      checks: write
      pull-requests: write
    secrets: inherit
    uses: ./.github/workflows/ci/test-auth-shared.yml
